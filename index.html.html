 <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF Training Dashboard PRO - v303G3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stat-card, .movement-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover, .movement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .nav-item {
            transition: all 0.2s ease;
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 4px solid white;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .movement-badge {
            transition: all 0.2s ease;
        }
        .movement-badge:hover {
            transform: scale(1.05);
        }
        .full-view-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            height: 100vh;
        }
        .content-area {
            overflow-y: auto;
            padding: 1rem;
        }
        .section-container {
            margin-bottom: 2rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
        }
        .set-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="full-view-container">
        <div class="w-full bg-gradient-to-b from-blue-600 to-blue-800 text-white shadow-lg">
            <div class="p-4 text-center border-b border-blue-500">
                <h1 class="text-2xl font-bold">CF TRACKER PRO</h1>
                <p class="text-xs text-blue-200">v303G3 - Vista Completa</p>
            </div>
            <nav class="mt-6">
                <div class="nav-item px-6 py-3 flex items-center cursor-pointer" id="refreshAllBtn">
                    <i class="fas fa-sync-alt mr-3"></i>
                    <span>Actualizar Todo</span>
                </div>
            </nav>
        </div>

        <div class="content-area">
            <div class="section-container">
                <h1 class="text-3xl font-bold mb-6">Dashboard de Entrenamiento</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="statsGrid"></div>

                <div class="mb-8" id="personalRecordsCard"></div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Volumen por movimientos WL</h3>
                            <select class="text-sm border rounded-lg px-2 py-1" id="volumeChartPeriod">
                                <option value="month">Este mes</option>
                                <option value="week">Esta semana</option>
                                <option value="year">Este año</option>
                            </select>
                        </div>
                        <canvas id="volumeByMovementChart" height="250"></canvas>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Top 5 movimientos</h3>
                            <select class="text-sm border rounded-lg px-2 py-1" id="topMovementsPeriod">
                                <option value="month">Este mes</option>
                                <option value="week">Esta semana</option>
                                <option value="year">Este año</option>
                            </select>
                        </div>
                        <div id="topMovementsList"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Estructura WOD</h3>
                            <select class="text-sm border rounded-lg px-2 py-1" id="wodStructurePeriod">
                                <option value="month">Este mes</option>
                                <option value="week">Esta semana</option>
                                <option value="year">Este año</option>
                            </select>
                        </div>
                        <canvas id="wodStructureChart" height="250"></canvas>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Balance de categorías</h3>
                            <select class="text-sm border rounded-lg px-2 py-1" id="categoryBalancePeriod">
                                <option value="month">Este mes</option>
                                <option value="week">Esta semana</option>
                                <option value="year">Este año</option>
                            </select>
                        </div>
                        <canvas id="categoryBalanceChart" height="250"></canvas>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Actividad Reciente</h3>
                            <span class="text-sm text-gray-500" id="recentActivityTime"></span>
                        </div>
                        <div class="space-y-4" id="recentActivityList"></div>
                    </div>
                </div>
            </div>

            <div class="section-container">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Registro de Entrenamientos</h1>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center" id="newWorkoutBtn">
                        <i class="fas fa-plus mr-2"></i> Nuevo Entrenamiento
                    </button>
                </div>
                
                <div id="trainingTypeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">¿Qué quieres registrar?</h3>
                            <button class="text-gray-500 hover:text-gray-700" id="closeTypeModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="training-type-card bg-white border border-blue-200 rounded-lg p-6 text-center cursor-pointer hover:border-blue-400 transition" id="weightliftingOption">
                                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-weight-hanging text-blue-600 text-2xl"></i>
                                </div>
                                <h4 class="font-semibold">Weightlifting</h4>
                                <p class="text-sm text-gray-500 mt-1">Registro de levantamientos</p>
                            </div>
                            <div class="training-type-card bg-white border border-green-200 rounded-lg p-6 text-center cursor-pointer hover:border-green-400 transition" id="wodOption">
                                <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-stopwatch text-green-600 text-2xl"></i>
                                </div>
                                <h4 class="font-semibold">WOD</h4>
                                <p class="text-sm text-gray-500 mt-1">Workout of the Day</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="weightliftingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto py-8">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl my-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Registrar Weightlifting</h3>
                            <button class="text-gray-500 hover:text-gray-700" id="closeWeightliftingModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="weightliftingForm">
                            <input type="hidden" id="weightliftingEditId">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="form-group">
                                    <label class="block text-gray-700 font-medium mb-2">Fecha*</label>
                                    <input type="date" id="wlDate" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div class="form-group">
                                    <label class="block text-gray-700 font-medium mb-2">RPE Sesión (1-10)*</label>
                                    <select id="wlRpe" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                        <option value="">Selecciona RPE</option>
                                        <option value="1">1 - Muy fácil</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5 - Moderado</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8 - Difícil</option>
                                        <option value="9">9</option>
                                        <option value="10">10 - Máximo esfuerzo</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <h4 class="text-lg font-semibold mb-3 border-b pb-2">Movimientos</h4>
                                
                                <div id="movementGroupsContainer"></div>
                                
                                <button type="button" class="mt-4 text-blue-600 hover:text-blue-800 flex items-center" id="addMovementBtn">
                                    <i class="fas fa-plus-circle mr-2"></i> Añadir otro movimiento
                                </button>
                                
                                <div class="mt-6 text-right">
                                    <div class="text-xl font-semibold mb-4">
                                        Volumen Total: <span id="totalVolume">0</span> kg
                                    </div>
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" class="px-6 py-2 border rounded-lg hover:bg-gray-100" id="cancelWeightlifting">
                                            Cancelar
                                        </button>
                                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                                            Guardar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="wodModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Registrar WOD</h3>
                            <button class="text-gray-500 hover:text-gray-700" id="closeWodModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="wodForm">
                            <input type="hidden" id="wodEditId">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="form-group">
                                    <label class="block text-gray-700 font-medium mb-2">Fecha*</label>
                                    <input type="date" id="wodDate" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div class="form-group">
                                    <label class="block text-gray-700 font-medium mb-2">Nombre del WOD*</label>
                                    <input type="text" id="wodName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Fran, Murph, etc." required>
                                </div>
                            </div>
                            
                            <div class="form-group mt-4">
                                <label class="block text-gray-700 font-medium mb-2">Descripción</label>
                                <textarea id="wodDescription" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                            </div>
                            
                            <div class="mt-4">
                                <label class="block text-gray-700 font-medium mb-2">Movimientos incluidos</label>
                                <div class="flex flex-wrap gap-2" id="wodMovementTags"></div>
                                <div class="mt-2 flex">
                                    <select id="wodMovementSelect" class="flex-1 px-4 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Selecciona un movimiento</option>
                                    </select>
                                    <button type="button" id="addWodMovementBtn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                <div class="form-group">
                                    <label class="block text-gray-700 font-medium mb-2">RPE (1-10)*</label>
                                    <select id="wodRpe" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                        <option value="">Selecciona RPE</option>
                                        <option value="1">1 - Muy fácil</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5 - Moderado</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8 - Difícil</option>
                                        <option value="9">9</option>
                                        <option value="10">10 - Máximo esfuerzo</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="block text-gray-700 font-medium mb-2">Resultado*</label>
                                    <input type="text" id="wodResult" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 15:25, 10 Rondas..." required>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" class="px-6 py-2 border rounded-lg hover:bg-gray-100" id="cancelWod">
                                    Cancelar
                                </button>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                                    Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="section-container">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Mis Movimientos</h1>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center" id="newMovementBtn">
                        <i class="fas fa-plus mr-2"></i> Nuevo Movimiento
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="flex space-x-2 overflow-x-auto pb-2">
                        <button class="category-filter px-4 py-2 rounded-full bg-blue-600 text-white whitespace-nowrap" data-category="all">
                            Todos
                        </button>
                        <button class="category-filter px-4 py-2 rounded-full bg-gray-200 hover:bg-gray-300 whitespace-nowrap" data-category="weightlifting">
                            Weightlifting
                        </button>
                        <button class="category-filter px-4 py-2 rounded-full bg-gray-200 hover:bg-gray-300 whitespace-nowrap" data-category="gymnastics">
                            Gimnasia
                        </button>
                        <button class="category-filter px-4 py-2 rounded-full bg-gray-200 hover:bg-gray-300 whitespace-nowrap" data-category="cardio">
                            Cardio
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="movementsGrid"></div>
                
                <div id="newMovementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Nuevo Movimiento</h3>
                            <button class="text-gray-500 hover:text-gray-700" id="closeMovementModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="movementForm">
                            <input type="hidden" id="movementEditId">
                            <div class="form-group mb-4">
                                <label class="block text-gray-700 font-medium mb-2">Nombre*</label>
                                <input type="text" id="movementName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            
                            <div class="form-group mb-4">
                                <label class="block text-gray-700 font-medium mb-2">Categoría*</label>
                                <select id="movementCategory" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Selecciona categoría</option>
                                    <option value="weightlifting">Weightlifting</option>
                                    <option value="gymnastics">Gimnasia</option>
                                    <option value="cardio">Cardio</option>
                                </select>
                            </div>
                            
                            <div class="form-group mb-4">
                                <label class="block text-gray-700 font-medium mb-2">Descripción</label>
                                <textarea id="movementDescription" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                            </div>
                            
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" class="px-6 py-2 border rounded-lg hover:bg-gray-100" id="cancelMovement">
                                    Cancelar
                                </button>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                                    Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="movementStatsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold" id="movementStatsTitle">Estadísticas</h3>
                            <button class="text-gray-500 hover:text-gray-700" id="closeStatsModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white rounded-lg shadow p-4">
                                <h4 class="font-semibold text-lg mb-2">Progreso de Peso Máximo</h4>
                                <canvas id="movementMaxWeightChart" height="200"></canvas>
                            </div>
                            <div class="bg-white rounded-lg shadow p-4">
                                <h4 class="font-semibold text-lg mb-2">Frecuencia de Entrenamiento</h4>
                                <canvas id="movementFrequencyChart" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-4 mb-6">
                            <h4 class="font-semibold text-lg mb-2">Historial Reciente</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peso (kg)</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Series x Reps</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RPE</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="movementHistoryTable"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="button" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg" id="closeStatsModalBtn">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-container">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Histórico de Entrenamientos</h1>
                    <div class="flex space-x-2">
                        <select class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="historyMonthFilter">
                            <option value="all">Todos los meses</option>
                        </select>
                        <select class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="historyTypeFilter">
                            <option value="all">Todos los tipos</option>
                            <option value="weightlifting">Weightlifting</option>
                            <option value="wod">WOD</option>
                        </select>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalles</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RPE</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Volumen</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="historyTableBody"></tbody>
                    </table>
                </div>
                
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-500" id="historyCount"></div>
                    <div class="flex space-x-2">
                        <button class="px-4 py-2 border rounded-lg hover:bg-gray-100 disabled:opacity-50" id="prevHistoryPage" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="px-4 py-2 border rounded-lg hover:bg-gray-100 disabled:opacity-50" id="nextHistoryPage" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Storage - Versión 303G3
        let appData = {
            version: '3.0.3G3',
            workouts: [],
            movements: [
                { id: 1, name: 'Back Squat', category: 'weightlifting', description: 'Sentadilla trasera' },
                { id: 2, name: 'Deadlift', category: 'weightlifting', description: 'Peso muerto' },
                { id: 3, name: 'Clean & Jerk', category: 'weightlifting', description: 'Cargada y envión' },
                { id: 4, name: 'Snatch', category: 'weightlifting', description: 'Arranque' },
                { id: 5, name: 'Bench Press', category: 'weightlifting', description: 'Press de banca' },
                { id: 6, name: 'Pull-ups', category: 'gymnastics', description: 'Dominadas' },
                { id: 7, name: 'Muscle-ups', category: 'gymnastics', description: 'Muscle-ups' },
                { id: 8, name: 'Handstand Walk', category: 'gymnastics', description: 'Caminata en manos' },
                { id: 9, name: 'Thrusters', category: 'weightlifting', description: 'Thrusters' },
                { id: 10, name: 'Burpees', category: 'gymnastics', description: 'Burpees' },
                { id: 11, name: 'Box Jumps', category: 'gymnastics', description: 'Saltos al cajón' },
                { id: 12, name: 'Double Unders', category: 'cardio', description: 'Saltos dobles de cuerda' }
            ],
            charts: {},
            historyPage: 1,
            itemsPerPage: 5
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initNavigation();
            initWorkoutForms();
            initMovementForms();
            initHistory();
            updateAllSections();
            
            document.getElementById('refreshAllBtn').addEventListener('click', updateAllSections);
        });

        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('cfTrackerData');
            if (savedData) {
                console.log("✅ Datos cargados desde localStorage.");
                try {
                    const parsedData = JSON.parse(savedData);
                    if (parsedData.workouts && Array.isArray(parsedData.workouts)) {
                        appData = { ...appData, ...parsedData, charts: {}, historyPage: 1 };
                    }
                } catch (e) { console.error("❌ Error al parsear datos de localStorage:", e); }
            } else {
                console.log("ℹ️ No se encontraron datos en localStorage, usando valores por defecto.");
            }
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('cfTrackerData', JSON.stringify({ ...appData, charts: {} }));
                console.log("✅ Datos guardados correctamente en localStorage.");
            } catch (e) {
                console.error("❌ Error al guardar datos:", e);
                alert('Error al guardar los datos.');
            }
        }

        // Initialize navigation
        function initNavigation() { /* Full view doesn't require tab switching */ }

        // Update all sections
        function updateAllSections() {
            updateDashboard();
            renderMovements();
            updateHistoryTable();
        }

        // Initialize workout forms
        function initWorkoutForms() {
            document.getElementById('newWorkoutBtn').addEventListener('click', () => document.getElementById('trainingTypeModal').classList.remove('hidden'));
            document.getElementById('closeTypeModal').addEventListener('click', () => document.getElementById('trainingTypeModal').classList.add('hidden'));
            
            document.getElementById('weightliftingOption').addEventListener('click', () => {
                document.getElementById('trainingTypeModal').classList.add('hidden');
                document.getElementById('weightliftingModal').classList.remove('hidden');
                resetWeightliftingForm();
                document.getElementById('wlDate').valueAsDate = new Date();
                addMovementGroup();
            });
            
            document.getElementById('wodOption').addEventListener('click', () => {
                document.getElementById('trainingTypeModal').classList.add('hidden');
                document.getElementById('wodModal').classList.remove('hidden');
                resetWodForm();
                document.getElementById('wodDate').valueAsDate = new Date();
                populateWodMovementSelect();
            });
            
            ['closeWeightliftingModal', 'cancelWeightlifting'].forEach(id => document.getElementById(id).addEventListener('click', () => document.getElementById('weightliftingModal').classList.add('hidden')));
            ['closeWodModal', 'cancelWod'].forEach(id => document.getElementById(id).addEventListener('click', () => document.getElementById('wodModal').classList.add('hidden')));
            
            document.getElementById('addMovementBtn').addEventListener('click', addMovementGroup);
            document.getElementById('addWodMovementBtn').addEventListener('click', addMovementToWod);
            document.getElementById('weightliftingForm').addEventListener('submit', saveWeightliftingWorkout);
            document.getElementById('wodForm').addEventListener('submit', saveWodWorkout);
            
            window.addEventListener('click', (e) => {
                ['trainingTypeModal', 'weightliftingModal', 'wodModal', 'newMovementModal', 'movementStatsModal'].forEach(modalId => {
                    if (e.target === document.getElementById(modalId)) document.getElementById(modalId).classList.add('hidden');
                });
            });
        }

        // Add a new movement group to weightlifting form
        function addMovementGroup(movementData = null) {
            const container = document.getElementById('movementGroupsContainer');
            const groupId = Date.now();
            const initialSets = movementData?.sets || 1;
            
            const groupHTML = `
                <div class="movement-group border border-gray-200 rounded-lg p-4 mb-4 fade-in" data-group-id="${groupId}">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Movimiento*</label>
                            <select class="movement-select w-full px-4 py-2 border rounded-lg" required>
                                <option value="">Selecciona</option>
                                ${appData.movements.filter(m => m.category === 'weightlifting').map(m => `<option value="${m.id}" ${movementData?.movementId == m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Series*</label>
                            <input type="number" min="1" value="${initialSets}" class="sets-input w-full px-4 py-2 border rounded-lg" required>
                        </div>
                        <div class="flex items-end">
                            <button type="button" class="remove-movement bg-red-100 text-red-600 hover:bg-red-200 px-4 py-2 rounded-lg w-full"><i class="fas fa-trash mr-2"></i> Eliminar</button>
                        </div>
                    </div>
                    <div class="sets-container mt-4">
                        <label class="block text-gray-700 font-medium mb-2">Detalles por serie:</label>
                        ${generateSetInputs(initialSets, movementData?.setsData)}
                    </div>
                </div>`;
            
            container.insertAdjacentHTML('beforeend', groupHTML);
            const newGroup = container.querySelector(`[data-group-id="${groupId}"]`);
            newGroup.querySelector('.remove-movement').addEventListener('click', () => { newGroup.remove(); calculateTotalVolume(); });
            newGroup.querySelectorAll('.weight-input, .reps-input').forEach(input => input.addEventListener('input', calculateTotalVolume));
            newGroup.querySelector('.sets-input').addEventListener('change', function() {
                const setsContainer = newGroup.querySelector('.sets-container');
                setsContainer.innerHTML = `<label class="block text-gray-700 font-medium mb-2">Detalles por serie:</label>${generateSetInputs(parseInt(this.value) || 1)}`;
                setsContainer.querySelectorAll('.weight-input, .reps-input').forEach(input => input.addEventListener('input', calculateTotalVolume));
                calculateTotalVolume();
            });
            calculateTotalVolume();
        }

        function generateSetInputs(numSets, setsData = null) {
            let html = '';
            for (let i = 1; i <= numSets; i++) {
                const setData = setsData?.[i - 1] || {};
                html += `
                    <div class="set-row">
                        <label class="text-sm text-gray-600">Serie ${i}</label>
                        <input type="number" min="0" step="0.5" placeholder="Peso (kg)" value="${setData.weight || ''}" class="weight-input w-full px-3 py-1 border rounded">
                        <input type="number" min="1" placeholder="Reps" value="${setData.reps || ''}" class="reps-input w-full px-3 py-1 border rounded">
                    </div>`;
            }
            return html;
        }

        function calculateTotalVolume() {
            let totalVolume = 0;
            document.querySelectorAll('.movement-group').forEach(group => {
                group.querySelectorAll('.weight-input').forEach((input, index) => {
                    totalVolume += (parseFloat(input.value) || 0) * (parseInt(group.querySelectorAll('.reps-input')[index].value) || 0);
                });
            });
            document.getElementById('totalVolume').textContent = totalVolume.toFixed(1);
        }

        function resetWeightliftingForm() {
            document.getElementById('weightliftingForm').reset();
            document.getElementById('weightliftingEditId').value = '';
            document.getElementById('movementGroupsContainer').innerHTML = '';
            document.getElementById('totalVolume').textContent = '0';
        }

        function resetWodForm() {
            document.getElementById('wodForm').reset();
            document.getElementById('wodEditId').value = '';
            document.getElementById('wodMovementTags').innerHTML = '';
        }

        function populateWodMovementSelect() {
            const select = document.getElementById('wodMovementSelect');
            select.innerHTML = '<option value="">Selecciona un movimiento</option>';
            appData.movements.forEach(m => select.innerHTML += `<option value="${m.id}">${m.name}</option>`);
        }

        function addMovementToWod() {
            const select = document.getElementById('wodMovementSelect');
            if (!select.value) return;
            const movement = appData.movements.find(m => m.id == select.value);
            const tagsContainer = document.getElementById('wodMovementTags');
            if (document.getElementById(`wod-movement-${select.value}`)) return;
            const tagHTML = `
                <div id="wod-movement-${select.value}" class="inline-flex items-center bg-blue-100 text-blue-800 rounded-full px-3 py-1 text-sm">
                    ${movement.name}
                    <button type="button" class="ml-2 text-blue-600 hover:text-blue-900 remove-movement" data-movement-id="${select.value}"><i class="fas fa-times"></i></button>
                </div>`;
            tagsContainer.insertAdjacentHTML('beforeend', tagHTML);
            tagsContainer.querySelector(`[data-movement-id='${select.value}']`).addEventListener('click', (e) => e.currentTarget.parentElement.remove());
            select.value = '';
        }

        function saveWeightliftingWorkout(e) {
            e.preventDefault();
            const editId = document.getElementById('weightliftingEditId').value;
            const movements = Array.from(document.querySelectorAll('.movement-group')).map(group => {
                const movementId = group.querySelector('.movement-select').value;
                if (!movementId) return null;
                const movement = appData.movements.find(m => m.id == movementId);
                const setsData = Array.from(group.querySelectorAll('.weight-input')).map((input, i) => ({
                    weight: parseFloat(input.value) || 0,
                    reps: parseInt(group.querySelectorAll('.reps-input')[i].value) || 0,
                }));
                const movementVolume = setsData.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                return { movementId: parseInt(movementId), movementName: movement.name, sets: setsData.length, setsData, volume: movementVolume };
            }).filter(Boolean);

            if (movements.length === 0) return alert('Debes añadir al menos un movimiento válido.');
            const totalVolume = movements.reduce((sum, m) => sum + m.volume, 0);
            const workout = {
                id: editId || Date.now().toString(),
                type: 'weightlifting',
                date: document.getElementById('wlDate').value,
                rpe: parseInt(document.getElementById('wlRpe').value),
                movements, totalVolume, updatedAt: new Date().toISOString()
            };
            if (editId) {
                const index = appData.workouts.findIndex(w => w.id === editId);
                appData.workouts[index] = { ...appData.workouts[index], ...workout };
            } else {
                appData.workouts.push({ ...workout, createdAt: new Date().toISOString() });
            }
            saveData();
            document.getElementById('weightliftingModal').classList.add('hidden');
            updateAllSections();
        }

        function saveWodWorkout(e) {
            e.preventDefault();
            const editId = document.getElementById('wodEditId').value;
            const movementIds = Array.from(document.querySelectorAll('#wodMovementTags .remove-movement')).map(tag => parseInt(tag.dataset.movementId));
            if (movementIds.length === 0) return alert('Debes añadir al menos un movimiento.');
            const workout = {
                id: editId || Date.now().toString(),
                type: 'wod',
                date: document.getElementById('wodDate').value,
                name: document.getElementById('wodName').value,
                description: document.getElementById('wodDescription').value,
                rpe: parseInt(document.getElementById('wodRpe').value),
                result: document.getElementById('wodResult').value,
                movementIds, updatedAt: new Date().toISOString()
            };
            if (editId) {
                const index = appData.workouts.findIndex(w => w.id === editId);
                appData.workouts[index] = { ...appData.workouts[index], ...workout };
            } else {
                appData.workouts.push({ ...workout, createdAt: new Date().toISOString() });
            }
            saveData();
            document.getElementById('wodModal').classList.add('hidden');
            updateAllSections();
        }

        function initMovementForms() {
            document.getElementById('newMovementBtn').addEventListener('click', () => {
                document.getElementById('newMovementModal').classList.remove('hidden');
                document.getElementById('movementForm').reset();
                document.getElementById('movementEditId').value = '';
            });
            ['closeMovementModal', 'cancelMovement'].forEach(id => document.getElementById(id).addEventListener('click', () => document.getElementById('newMovementModal').classList.add('hidden')));
            document.getElementById('movementForm').addEventListener('submit', saveMovement);
            document.querySelectorAll('.category-filter').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.category-filter').forEach(btn => btn.classList.replace('bg-blue-600', 'bg-gray-200') || btn.classList.replace('text-white', 'text-gray-800'));
                    this.classList.replace('bg-gray-200', 'bg-blue-600');
                    this.classList.add('text-white');
                    renderMovements(this.dataset.category);
                });
            });
            ['closeStatsModal', 'closeStatsModalBtn'].forEach(id => document.getElementById(id).addEventListener('click', () => document.getElementById('movementStatsModal').classList.add('hidden')));
        }

        function saveMovement(e) {
            e.preventDefault();
            const id = document.getElementById('movementEditId').value;
            const movement = {
                id: id || Date.now(),
                name: document.getElementById('movementName').value,
                category: document.getElementById('movementCategory').value,
                description: document.getElementById('movementDescription').value
            };
            if (id) {
                const index = appData.movements.findIndex(m => m.id == id);
                appData.movements[index] = movement;
            } else {
                appData.movements.push(movement);
            }
            saveData();
            document.getElementById('newMovementModal').classList.add('hidden');
            renderMovements();
            populateWodMovementSelect();
        }

        function renderMovements(category = 'all') {
            const container = document.getElementById('movementsGrid');
            container.innerHTML = '';
            const filtered = category === 'all' ? appData.movements : appData.movements.filter(m => m.category === category);
            const colors = { weightlifting: 'bg-blue-100 text-blue-800', gymnastics: 'bg-purple-100 text-purple-800', cardio: 'bg-orange-100 text-orange-800' };
            filtered.forEach(m => {
                const card = document.createElement('div');
                card.className = 'movement-card bg-white rounded-lg shadow p-6 flex flex-col';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-semibold">${m.name}</h3>
                        <span class="text-xs px-3 py-1 rounded-full ${colors[m.category] || ''}">${getCategoryName(m.category)}</span>
                    </div>
                    <p class="text-gray-600 mb-4 flex-grow">${m.description || ''}</p>
                    <div class="mt-auto flex justify-between items-center">
                        <button class="edit-movement text-blue-600 hover:text-blue-800 text-sm" data-movement-id="${m.id}"><i class="fas fa-edit mr-1"></i> Editar</button>
                        <button class="view-stats px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm" data-movement-id="${m.id}"><i class="fas fa-chart-line mr-1"></i> Estadísticas</button>
                    </div>`;
                container.appendChild(card);
                card.querySelector('.edit-movement').addEventListener('click', () => editMovement(m.id));
                card.querySelector('.view-stats').addEventListener('click', () => showMovementStats(m.id));
            });
        }

        function getCategoryName(key) {
            return { weightlifting: 'Weightlifting', gymnastics: 'Gimnasia', cardio: 'Cardio' }[key] || key;
        }

        function editMovement(id) {
            const m = appData.movements.find(mov => mov.id == id);
            if (!m) return;
            document.getElementById('movementEditId').value = m.id;
            document.getElementById('movementName').value = m.name;
            document.getElementById('movementCategory').value = m.category;
            document.getElementById('movementDescription').value = m.description || '';
            document.getElementById('newMovementModal').classList.remove('hidden');
        }

        function showMovementStats(movementId) {
            const m = appData.movements.find(mov => mov.id == movementId);
            if (!m) return;
            document.getElementById('movementStatsTitle').textContent = `Estadísticas: ${m.name}`;
            const workouts = appData.workouts.filter(w => (w.type === 'weightlifting' && w.movements.some(mov => mov.movementId == movementId)) || (w.type === 'wod' && w.movementIds.includes(movementId)));
            renderMovementCharts(prepareMaxWeightData(workouts, movementId), prepareFrequencyData(workouts));
            renderMovementHistory(workouts, movementId);
            document.getElementById('movementStatsModal').classList.remove('hidden');
        }

        function prepareMaxWeightData(workouts, movementId) {
            const data = workouts.filter(w => w.type === 'weightlifting').map(w => ({ date: w.date, maxWeight: Math.max(...w.movements.find(m => m.movementId == movementId)?.setsData.map(s => s.weight) || [0]) })).sort((a, b) => new Date(a.date) - new Date(b.date));
            return { labels: data.map(i => formatDate(i.date)), weights: data.map(i => i.maxWeight) };
        }

        function prepareFrequencyData(workouts) {
            const data = {};
            workouts.forEach(w => { const m = new Date(w.date).toISOString().slice(0, 7); data[m] = (data[m] || 0) + 1; });
            const result = Object.entries(data).sort(([a], [b]) => a.localeCompare(b));
            return { labels: result.map(([m]) => formatMonth(m)), counts: result.map(([,c]) => c) };
        }

        function renderMovementCharts(maxWeightData, frequencyData) {
            ['movementMaxWeightChart', 'movementFrequencyChart'].forEach(id => { if (appData.charts[id]) appData.charts[id].destroy(); });
            appData.charts.movementMaxWeightChart = new Chart(document.getElementById('movementMaxWeightChart').getContext('2d'), { type: 'line', data: { labels: maxWeightData.labels, datasets: [{ label: 'Peso Máximo (kg)', data: maxWeightData.weights, borderColor: '#3B82F6', tension: 0.3 }] }, options: { responsive: true, scales: { y: { beginAtZero: true } } } });
            appData.charts.movementFrequencyChart = new Chart(document.getElementById('movementFrequencyChart').getContext('2d'), { type: 'bar', data: { labels: frequencyData.labels, datasets: [{ label: 'Veces entrenado', data: frequencyData.counts, backgroundColor: '#10B981' }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } } });
        }
        
        function renderMovementHistory(workouts, movementId) {
            const tbody = document.getElementById('movementHistoryTable');
            tbody.innerHTML = '';
            workouts.filter(w => w.type === 'weightlifting').sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(w => {
                const mData = w.movements.find(m => m.movementId == movementId);
                if (!mData) return;
                mData.setsData.forEach((set, i) => {
                    const row = tbody.insertRow();
                    if (i === 0) row.innerHTML = `<td class="px-4 py-2" rowspan="${mData.setsData.length}">${formatDate(w.date)}</td>`;
                    row.innerHTML += `<td class="px-4 py-2">${set.weight || '-'}</td><td class="px-4 py-2">${set.reps || '-'}</td><td class="px-4 py-2">${w.rpe || '-'}</td>`;
                });
            });
            if (tbody.innerHTML === '') tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4">No hay historial.</td></tr>`;
        }

        function initHistory() {
            const monthFilter = document.getElementById('historyMonthFilter');
            const months = [...new Set(appData.workouts.map(w => new Date(w.date).toISOString().slice(0, 7)))].sort().reverse();
            months.forEach(m => monthFilter.innerHTML += `<option value="${m}">${formatMonth(m)}</option>`);
            ['historyMonthFilter', 'historyTypeFilter'].forEach(id => document.getElementById(id).addEventListener('change', () => { appData.historyPage = 1; updateHistoryTable(); }));
            document.getElementById('prevHistoryPage').addEventListener('click', () => { if(appData.historyPage > 1) { appData.historyPage--; updateHistoryTable(); } });
            document.getElementById('nextHistoryPage').addEventListener('click', () => { appData.historyPage++; updateHistoryTable(); });
        }

        let filteredWorkoutsCount = 0;
        function updateHistoryTable() {
            const month = document.getElementById('historyMonthFilter').value;
            const type = document.getElementById('historyTypeFilter').value;
            const filtered = appData.workouts.filter(w => (month === 'all' || new Date(w.date).toISOString().slice(0, 7) === month) && (type === 'all' || w.type === type)).sort((a,b) => new Date(b.date) - new Date(a.date));
            filteredWorkoutsCount = filtered.length;
            const paginated = filtered.slice((appData.historyPage - 1) * appData.itemsPerPage, appData.historyPage * appData.itemsPerPage);
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            if(paginated.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center p-4">No se encontraron entrenamientos.</td></tr>`;
            } else {
                paginated.forEach(w => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td class="px-6 py-4">${formatDate(w.date)}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs ${w.type === 'weightlifting' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${w.type}</span></td>
                        <td class="px-6 py-4">
                            <div class="font-medium">${w.type === 'wod' ? w.name : w.movements.map(m=>m.movementName).join(', ')}</div>
                            <div class="text-sm text-gray-500">${w.type === 'wod' ? w.movementIds.length : w.movements.length} movs</div>
                        </td>
                        <td class="px-6 py-4">${w.rpe}/10</td>
                        <td class="px-6 py-4">${w.totalVolume ? w.totalVolume.toFixed(1) + ' kg' : '-'}</td>
                        <td class="px-6 py-4 text-right">
                            <button class="edit-workout text-blue-600 hover:text-blue-900 mr-3" data-workout-id="${w.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-workout text-red-600 hover:text-red-900" data-workout-id="${w.id}"><i class="fas fa-trash"></i></button>
                        </td>`;
                    row.querySelector('.edit-workout').addEventListener('click', () => editWorkout(w.id));
                    row.querySelector('.delete-workout').addEventListener('click', () => deleteWorkout(w.id));
                });
            }
            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredWorkoutsCount / appData.itemsPerPage);
            document.getElementById('prevHistoryPage').disabled = appData.historyPage <= 1;
            document.getElementById('nextHistoryPage').disabled = appData.historyPage >= totalPages;
            document.getElementById('historyCount').textContent = `Mostrando ${Math.min((appData.historyPage-1)*appData.itemsPerPage+1, filteredWorkoutsCount)}-${Math.min(appData.historyPage*appData.itemsPerPage, filteredWorkoutsCount)} de ${filteredWorkoutsCount}`;
        }
        
        function editWorkout(id) {
            const w = appData.workouts.find(wo => wo.id == id);
            if (!w) return;
            if (w.type === 'weightlifting') {
                resetWeightliftingForm();
                document.getElementById('weightliftingEditId').value = w.id;
                document.getElementById('wlDate').value = w.date;
                document.getElementById('wlRpe').value = w.rpe;
                w.movements.forEach(m => addMovementGroup(m));
                document.getElementById('weightliftingModal').classList.remove('hidden');
            } else {
                resetWodForm();
                document.getElementById('wodEditId').value = w.id;
                document.getElementById('wodDate').value = w.date;
                document.getElementById('wodName').value = w.name;
                document.getElementById('wodDescription').value = w.description;
                document.getElementById('wodRpe').value = w.rpe;
                document.getElementById('wodResult').value = w.result;
                populateWodMovementSelect();
                w.movementIds.forEach(movId => { document.getElementById('wodMovementSelect').value = movId; addMovementToWod(); });
                document.getElementById('wodModal').classList.remove('hidden');
            }
        }

        function deleteWorkout(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este entrenamiento?')) {
                appData.workouts = appData.workouts.filter(w => w.id != id);
                saveData();
                updateAllSections();
            }
        }

        // --- DASHBOARD ---
        function updateDashboard() {
            updateStatsCards();
            updatePersonalRecordsCard(); // RM card
            updateVolumeByMovementChart();
            updateTopMovementsList();
            updateWodStructureChart();
            updateCategoryBalanceChart();
            updateRecentActivity();
        }

        function updateStatsCards() {
            const grid = document.getElementById('statsGrid');
            grid.innerHTML = '';
            const weekWorkouts = filterWorkoutsByPeriod('week');
            const prevWeekWorkouts = filterWorkoutsByPeriod('previous_week');
            const monthWorkouts = filterWorkoutsByPeriod('month');
            const prevMonthWorkouts = filterWorkoutsByPeriod('previous_month');

            const weekVolume = weekWorkouts.reduce((s, w) => s + (w.totalVolume || 0), 0);
            const prevWeekVolume = prevWeekWorkouts.reduce((s, w) => s + (w.totalVolume || 0), 0);
            const weekRpe = weekWorkouts.length ? weekWorkouts.reduce((s, w) => s + w.rpe, 0) / weekWorkouts.length : 0;
            const prevWeekRpe = prevWeekWorkouts.length ? prevWeekWorkouts.reduce((s, w) => s + w.rpe, 0) / prevWeekWorkouts.length : 0;

            const getComparison = (current, previous) => {
                if (previous === 0) return current > 0 ? '<span class="text-green-500"><i class="fas fa-arrow-up"></i></span>' : '';
                const change = ((current - previous) / previous) * 100;
                return `<span class="${change >= 0 ? 'text-green-500' : 'text-red-500'}"><i class="fas fa-arrow-${change >= 0 ? 'up' : 'down'}"></i> ${change.toFixed(0)}%</span>`;
            };

            const stats = [
                { title: 'Sesiones este mes', value: monthWorkouts.length, icon: 'calendar-day', color: 'bg-blue-100 text-blue-600', comp: getComparison(monthWorkouts.length, prevMonthWorkouts.length) },
                { title: 'Volumen semanal', value: `${weekVolume.toFixed(1)} kg`, icon: 'weight-hanging', color: 'bg-green-100 text-green-600', comp: getComparison(weekVolume, prevWeekVolume) },
                { title: 'RPE medio semanal', value: weekRpe.toFixed(1), icon: 'brain', color: 'bg-purple-100 text-purple-600', comp: getComparison(weekRpe, prevWeekRpe) },
                { title: 'Volumen total', value: `${appData.workouts.reduce((s, w) => s + (w.totalVolume || 0), 0).toFixed(1)} kg`, icon: 'database', color: 'bg-orange-100 text-orange-600', comp: '' }
            ];
            
            stats.forEach(s => grid.innerHTML += `<div class="stat-card bg-white rounded-lg shadow p-6 flex items-center"><div class="p-3 rounded-full ${s.color} mr-4"><i class="fas fa-${s.icon} text-lg"></i></div><div><h3 class="text-gray-500 font-medium">${s.title}</h3><p class="text-2xl font-bold">${s.value} <span class="text-sm font-normal">${s.comp}</span></p></div></div>`);
        }
        
        function calculateRMs() {
            const personalRecords = {};
            const wlWorkouts = appData.workouts.filter(w => w.type === 'weightlifting');

            wlWorkouts.forEach(workout => {
                workout.movements.forEach(movement => {
                    movement.setsData.forEach(set => {
                        // We only care about single-rep sets for the REAL 1RM
                        if (set.reps === 1 && set.weight > 0) {
                            if (!personalRecords[movement.movementName] || set.weight > personalRecords[movement.movementName]) {
                                personalRecords[movement.movementName] = set.weight;
                            }
                        }
                    });
                });
            });
            return personalRecords;
        }

        function updatePersonalRecordsCard() {
            const container = document.getElementById('personalRecordsCard');
            const records = calculateRMs();
            const sortedRecords = Object.entries(records).sort(([a], [b]) => a.localeCompare(b));

            if (sortedRecords.length === 0) {
                container.innerHTML = '';
                return;
            }

            let listHTML = sortedRecords.map(([name, rm]) => `
                <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                    <span class="font-medium text-gray-700">${name}</span>
                    <span class="font-bold text-lg text-blue-600">${rm.toFixed(1)} kg</span>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Récords Personales (1RM Real)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-2">
                        ${listHTML}
                    </div>
                </div>
            `;
        }

        function updateChart(chartId, type, data, options) {
            if (appData.charts[chartId]) appData.charts[chartId].destroy();
            appData.charts[chartId] = new Chart(document.getElementById(chartId).getContext('2d'), { type, data, options });
        }

        function updateVolumeByMovementChart() {
            const filtered = filterWorkoutsByPeriod(document.getElementById('volumeChartPeriod').value).filter(w => w.type === 'weightlifting');
            const data = {};
            filtered.forEach(w => w.movements.forEach(m => data[m.movementName] = (data[m.movementName] || 0) + m.volume));
            const sorted = Object.entries(data).sort(([,a],[,b]) => b-a).slice(0,10);
            updateChart('volumeByMovementChart', 'bar', {
                labels: sorted.map(([n]) => n),
                datasets: [{ label: 'Volumen (kg)', data: sorted.map(([,v]) => v), backgroundColor: 'rgba(59, 130, 246, 0.7)' }]
            }, { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } });
            document.getElementById('volumeChartPeriod').onchange = updateVolumeByMovementChart;
        }

        function updateTopMovementsList() {
            const filtered = filterWorkoutsByPeriod(document.getElementById('topMovementsPeriod').value).filter(w => w.type === 'weightlifting');
            const data = {};
            filtered.forEach(w => w.movements.forEach(m => data[m.movementName] = (data[m.movementName] || 0) + 1));
            const sorted = Object.entries(data).sort(([,a],[,b]) => b-a).slice(0,5);
            document.getElementById('topMovementsList').innerHTML = sorted.map(([n, c], i) => `<div class="flex items-center justify-between py-3 border-b border-gray-100"><div class="flex items-center"><span class="text-gray-500 font-medium mr-2">${i+1}.</span><span class="font-medium">${n}</span></div><span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${c} ses.</span></div>`).join('') || '<p class="text-gray-500">No hay datos.</p>';
            document.getElementById('topMovementsPeriod').onchange = updateTopMovementsList;
        }

        function updateWodStructureChart() {
            const filtered = filterWorkoutsByPeriod(document.getElementById('wodStructurePeriod').value).filter(w => w.type === 'wod');
            const data = {};
            filtered.forEach(w => data[w.name] = (data[w.name] || 0) + 1);
            const sorted = Object.entries(data).sort(([,a],[,b]) => b-a).slice(0,5);
            updateChart('wodStructureChart', 'doughnut', {
                labels: sorted.map(([n]) => n),
                datasets: [{ data: sorted.map(([,c]) => c), backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#F43F5E'] }]
            }, { responsive: true, plugins: { legend: { position: 'right' } } });
            document.getElementById('wodStructurePeriod').onchange = updateWodStructureChart;
        }
        
        function updateCategoryBalanceChart() {
            const period = document.getElementById('categoryBalancePeriod').value;
            const filteredWorkouts = filterWorkoutsByPeriod(period);
            const categoryCounts = { 'weightlifting': 0, 'gymnastics': 0, 'cardio': 0 };

            filteredWorkouts.forEach(workout => {
                let movements = [];
                if (workout.type === 'wod') {
                    movements = workout.movementIds.map(id => appData.movements.find(m => m.id == id));
                } else if (workout.type === 'weightlifting') {
                    // CORRECTED LINE: from appData.moveents to appData.movements
                    movements = workout.movements.map(m => appData.movements.find(mov => mov.id == m.movementId));
                }
                
                const uniqueCategories = [...new Set(movements.filter(Boolean).map(m => m.category))];
                uniqueCategories.forEach(cat => {
                    if (categoryCounts.hasOwnProperty(cat)) {
                        categoryCounts[cat]++;
                    }
                });
            });

            updateChart('categoryBalanceChart', 'radar', {
                labels: ['Weightlifting', 'Gimnasia', 'Cardio'],
                datasets: [{ 
                    label: 'Sesiones por Categoría', 
                    data: Object.values(categoryCounts), 
                    backgroundColor: 'rgba(59, 130, 246, 0.2)', 
                    borderColor: '#3B82F6' 
                }]
            }, { 
                responsive: true, 
                scales: { r: { suggestedMin: 0, ticks: { stepSize: 1 } } }, 
                plugins: { legend: { display: false } } 
            });
            document.getElementById('categoryBalancePeriod').onchange = updateCategoryBalanceChart;
        }


        function updateRecentActivity() {
            const recent = [...appData.workouts].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
            document.getElementById('recentActivityList').innerHTML = recent.map(w => w.type === 'weightlifting' ?
                `<div class="bg-white rounded-lg shadow p-4"><div class="flex justify-between items-start"><div><h4 class="font-semibold">${w.movements.map(m=>m.movementName).join(', ')}</h4><p class="text-sm text-gray-500">${formatDate(w.date)}</p></div><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">WL</span></div><div class="mt-3 flex justify-between items-center text-sm"><span>${w.movements.length} movs • ${w.totalVolume.toFixed(1)} kg</span><span class="font-medium">RPE: ${w.rpe}/10</span></div></div>` :
                `<div class="bg-white rounded-lg shadow p-4"><div class="flex justify-between items-start"><div><h4 class="font-semibold">${w.name}</h4><p class="text-sm text-gray-500">${formatDate(w.date)}</p></div><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">WOD</span></div><div class="mt-3 flex justify-between items-center text-sm"><span>Resultado: ${w.result}</span><span class="font-medium">RPE: ${w.rpe}/10</span></div></div>`
            ).join('') || '<p class="text-gray-500">No hay actividad reciente.</p>';
            document.getElementById('recentActivityTime').textContent = `Actualizado: ${formatTime(new Date())}`;
        }
        
        // Utility functions
        function filterWorkoutsByPeriod(period) {
            const now = new Date();
            let start, end = new Date(now.getTime() + 86400000); // include today
            switch(period) {
                case 'week':
                    start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
                    break;
                case 'previous_week':
                    end = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
                    start = new Date(new Date().setDate(end.getDate() - 7));
                    break;
                case 'month':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'previous_month':
                    end = new Date(now.getFullYear(), now.getMonth(), 1);
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    break;
                case 'year':
                    start = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                    break;
                default:
                    return appData.workouts;
            }
            return appData.workouts.filter(w => { const d = new Date(w.date); return d >= start && d < end; });
        }

        function formatDate(d) { return new Date(d).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' }); }
        function formatMonth(m) { const [y, mo] = m.split('-'); return new Date(y, mo-1).toLocaleDateString('es-ES', {month: 'long', year: 'numeric'}); }
        function formatTime(d) { return d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); }

    </script>
</body>
</html>